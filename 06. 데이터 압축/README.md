# 06. 데이터 압축

MySQL 서버에서 데이터 파일의 크기는 저장 공간뿐 아니라 성능과 운영 비용에 직접적인 영향을 준다.

데이터가 커질수록 디스크 I/O량이 증가하고 백업과 복구 시간도 길어진다.

이를 완화하기 위해 MySQL은 **페이지 압축**과 **테이블 압축**이라는 두 가지 다른 방식의 압축 기능을 제공한다.

두 방식은 동작 위치와 성능 특성이 완전히 다르므로 구분해서 이해해야 한다.

## **6.1 페이지 압축**

페이지 압축은 **Transparent Page Compression**이라고도 불린다.

이 방식은 MySQL 서버가 디스크에 데이터를 기록하는 시점에 압축이 적용된다.

### **핵심 개념**

- InnoDB 내부에서는 항상 **압축이 해제된 페이지**만 사용한다.
- 압축은 디스크에 쓸 때만 적용되고 읽을 때는 자동으로 해제된다.
- MySQL 내부 로직은 압축 여부를 인식하지 않는다.

즉, 압축은 MySQL 엔진 입장에서는 **완전히 투명하게 동작**한다.

### **동작 방식**

페이지 압축의 동작 흐름은 다음과 같다.

1. InnoDB는 16KB 데이터 페이지를 생성한다.
2. 디스크에 기록하기 전에 페이지를 압축한다.
3. 압축 결과가 예를 들어 7KB라면 디스크에는 7KB만 기록한다.
4. 남은 공간은 파일 시스템의 **펀치 홀(punch hole)** 기능으로 반환한다.
5. 디스크에서 읽을 때는 압축된 데이터와 빈 공간을 합쳐 다시 16KB로 복원한다.

이 과정을 그림으로 나타낸 것이 [그림 6-1]이다.

<img width="649" height="359" alt="image" src="https://github.com/user-attachments/assets/06d1a3ff-b261-4c57-8320-dccfd9a07419" />

### **제약 사항과 한계**

페이지 압축은 모든 환경에서 사용할 수 있는 기능은 아니다.

- 파일 시스템과 운영체제가 펀치 홀 기능을 지원해야 한다.
- 백업과 복구 과정에서는 펀치 홀이 유지되지 않을 수 있다.
- 데이터 파일을 복사하면 실제 파일 크기가 다시 커질 수 있다.

이러한 이유로 페이지 압축은 **이론적으로는 매력적이지만 실무에서는 제한적으로 사용**된다.

## **6.2 테이블 압축**

테이블 압축은 페이지 압축과 완전히 다른 개념이다.

이 방식은 InnoDB 내부에서 **압축된 페이지 자체를 관리**한다.

### **테이블 압축의 특징**

- 운영체제나 파일 시스템의 지원 여부와 무관하게 동작한다.
- 디스크뿐 아니라 버퍼 풀에서도 압축된 형태가 유지된다.
- CPU 비용과 메모리 사용 패턴에 큰 영향을 준다.

테이블 압축은 공간 절약 효과는 크지만 성능 트레이드오프가 명확하다.

### **6.2.1 압축 테이블 생성**

테이블 압축을 사용하려면 몇 가지 전제 조건이 필요하다.

- innodb_file_per_table 옵션이 ON이어야 한다.
- 테이블을 생성할 때 ROW_FORMAT=COMPRESSED를 지정해야 한다.
- KEY_BLOCK_SIZE로 목표 압축 크기를 명시해야 한다.

압축 테이블 생성 예시는 다음과 같다.

```sql
CREATE TABLE compressed_table (
  c1 INT PRIMARY KEY
)
ROW_FORMAT=COMPRESSED
KEY_BLOCK_SIZE=8;
```

여기서 KEY_BLOCK_SIZE=8은 **압축된 페이지의 목표 크기가 8KB**임을 의미한다.

### **6.2.2 KEY_BLOCK_SIZE 결정**

KEY_BLOCK_SIZE는 테이블 압축에서 가장 중요한 설정이다.

- 값이 너무 작으면 압축 실패가 자주 발생한다.
- 값이 너무 크면 압축 효과가 줄어든다.
- 설정 가능한 값은 일반적으로 4KB 또는 8KB다.

책에서는 실제 employees 테이블을 예로 들어 압축 성공률을 비교한다.

이 결과는 [그림 6-2]에 해당한다.

<img width="412" height="440" alt="image" src="https://github.com/user-attachments/assets/4af4abcb-9f04-4a59-918c-df4821009f56" />

핵심 포인트는 다음과 같다.

- 모든 인덱스가 동일한 압축 성공률을 가지지 않는다.
- PRIMARY 키와 보조 인덱스의 압축 특성이 다르다.
- 압축 실패율이 지나치게 높으면 CPU 사용량이 급증한다.

### **6.2.3 압축된 페이지의 버퍼 풀 적재와 사용**

테이블 압축을 사용할 경우 InnoDB 버퍼 풀은 **두 가지 형태의 페이지**를 관리한다.

- 압축된 페이지
- 압축이 해제된 페이지

이를 위해 InnoDB는 다음과 같은 구조를 사용한다.

- 일반 LRU 리스트
- Unzip_LRU 리스트

동작 방식은 다음과 같다.

- 디스크에서 읽은 페이지는 압축된 상태로 버퍼 풀에 적재된다.
- 실제 접근이 발생하면 압축이 해제된 페이지가 Unzip_LRU에 저장된다.
- 접근 빈도에 따라 압축 해제된 페이지를 유지하거나 제거한다.

이 구조로 인해 다음과 같은 특징이 나타난다.

- 메모리 사용량이 증가할 수 있다.
- CPU 사용량이 눈에 띄게 증가할 수 있다.
- 디스크 I/O는 줄어들 수 있다.

### **6.2.4 테이블 압축 관련 설정**

테이블 압축에는 여러 시스템 변수가 관여한다.

대표적인 변수는 다음과 같다.

- innodb_cmp_per_index_enabled
    
    인덱스별 압축 성공과 실패 통계를 수집한다.
    
- innodb_compression_level
    
    압축 알고리즘의 강도를 조절한다.
    
    값이 높을수록 압축률은 좋아지지만 CPU 사용량이 증가한다.
    
- innodb_compression_failure_threshold_pct
    
    압축 실패율이 일정 비율을 넘으면 패딩을 늘려 압축 성공률을 높인다.
    
- innodb_compression_pad_pct_max
    
    패딩 크기의 최대 비율을 제한한다.
    

이 설정들은 **압축률을 높이기 위한 장치이자 CPU 사용량을 제어하기 위한 안전장치**다.

## **6장 전체 정리**

6장은 단순히 압축 기능을 소개하는 장이 아니다.

이 장의 핵심은 **공간 절약과 성능 사이의 균형**이다.

- 페이지 압축은 디스크 공간 절약에는 효과적이지만 환경 의존성이 크다.
- 테이블 압축은 범용적이지만 CPU와 메모리 비용이 증가한다.
- 압축은 무조건 좋은 선택이 아니라 워크로드에 따라 판단해야 한다.
- 읽기 빈도가 높고 변경이 적은 테이블에 더 적합하다.
- 쓰기와 변경이 잦은 테이블에는 오히려 성능 저하를 유발할 수 있다.

결론적으로 테이블 압축은 **옵션이 아니라 설계 선택**이다.

적용 전에 반드시 테스트와 측정이 필요하다.
