# 07. 데이터 암호화

MySQL 8.0에서는 디스크에 저장되는 데이터 보호를 위해 **TDE(Transparent Data Encryption)** 기반의 암호화 기능을 제공한다.

이 장에서는 MySQL 서버가 데이터를 어디서 어떤 방식으로 암호화하는지, 그리고 키 관리와 로그 암호화까지의 전체 구조를 설명한다.

## **7.1 MySQL 서버의 데이터 암호화**

MySQL 8.0은 **디스크에 저장되는 데이터(Data at Rest)** 를 암호화하는 기능을 제공한다.

- 메모리(InnoDB 버퍼 풀)에 존재하는 데이터는 암호화되지 않는다.
- 디스크 I/O 시점에만 InnoDB I/O 레이어에서 암호화와 복호화가 수행된다.
- MySQL 내부나 사용자 쿼리 관점에서는 암호화 여부를 인식하지 않는다.
- 이러한 특성 때문에 **TDE(Transparent Data Encryption)** 라고 부른다.

암호화는 **InnoDB 스토리지 엔진의 I/O 레이어에서 수행**된다.

- MySQL 엔진 레벨 기능이 아니다.
- 스토리지 엔진 단위 기능이다.

## **7.1.1 Data at Rest 암호화 범위**

암호화 대상

- InnoDB 테이블 데이터 파일
- 인덱스 데이터
- 테이블스페이스 파일
- 리두 로그
- 언두 로그
- 바이너리 로그

암호화 대상이 아닌 것

- 메모리 상의 데이터
- 네트워크 전송 구간
- 일반 SELECT 결과

## **7.1.2 2단계 키 관리 구조**

MySQL TDE는 **마스터 키와 테이블스페이스 키로 구성된 2단계 키 구조**를 사용한다.

<img width="557" height="416" alt="image" src="https://github.com/user-attachments/assets/880825ac-cd35-4242-a661-9dde8ecd3e83" />

### **마스터 키**

- 테이블스페이스 키를 암호화하는 키다.
- 실제 데이터 페이지를 암호화하지 않는다.
- Keyring 플러그인을 통해 관리된다.
- 외부 KMS 또는 파일 기반으로 저장된다.
- 주기적 로테이션 대상이다.

### **테이블스페이스 키**

- 실제 데이터 페이지를 암호화하는 키다.
- 테이블 또는 테이블스페이스 단위로 생성된다.
- 테이블이 삭제될 때까지 변경되지 않는다.
- MySQL 외부로 노출되지 않는다.

2단계 구조의 목적은 다음과 같다.

- 테이블스페이스 키 변경 시 전체 데이터 재암호화를 방지한다.
- 마스터 키 교체 시에도 데이터 파일 전체를 다시 암호화하지 않는다.
- 키 유출 위험을 최소화한다.

## **7.1.3 키 변경 시 동작 차이**

### **마스터 키 변경**

- 테이블스페이스 키만 복호화 후 재암호화한다.
- 실제 데이터 페이지는 재암호화하지 않는다.
- 디스크 I/O 비용이 상대적으로 작다.
- 운영 중 로테이션이 가능하다.

```sql
ALTER INSTANCE ROTATE INNODB MASTER KEY;
```

### **테이블스페이스 키 변경**

- 해당 테이블의 모든 데이터 페이지를 복호화한다.
- 새로운 테이블스페이스 키로 다시 암호화한다.
- 전체 데이터 재암호화가 발생한다.
- 비용이 매우 크다.
- 일반적으로 직접 변경하지 않는다.

## **7.1.4 암호화 알고리즘**

- AES 256비트를 사용한다.
- 테이블스페이스 키 암호화는 AES ECB 방식이다.
- 실제 데이터 파일 암호화는 AES CBC 방식이다.

암호화 결과는 페이지 크기와 동일하다.

- 데이터 파일 크기는 암호화 여부와 무관하다.
- InnoDB 버퍼 풀 효율도 크게 달라지지 않는다.

## **7.1.5 암호화와 성능**

- 디스크에서 처음 읽을 때만 복호화 비용이 발생한다.
- 버퍼 풀에 적재된 이후에는 성능 차이가 거의 없다.
- 디스크 I/O 비중이 높은 환경에서만 영향이 체감된다.
- CPU 사용량이 약간 증가할 수 있다.

## **7.2 keyring_file 플러그인 설치**

MySQL 커뮤니티 에디션에서는 **keyring_file 플러그인만 사용 가능**하다.

- 마스터 키를 로컬 파일에 저장한다.
- 파일 자체는 암호화되지 않는다.
- 접근 권한 관리가 매우 중요하다.

```sql
early-plugin-load=keyring_file.so
keyring_file_data=/secure/path/keyring
```

- MySQL 서버 시작 시 가장 먼저 로딩되어야 한다.
- 서버가 여러 개라면 각 서버마다 별도 키 파일을 사용해야 한다.

## **7.3 테이블 암호화**

### **7.3.1 테이블 생성 시 암호화**

```sql
CREATE TABLE tab_encrypted (
  id INT PRIMARY KEY,
  data VARCHAR(100)
) ENCRYPTION='Y';
```

- 일반적인 테이블 생성 구문과 동일하며, 마지막에 ENCRYPTION=’Y’ 옵션만 추가로 넣으면 된다.
- 테이블 단위 암호화다.
- 생성 시 테이블스페이스 키가 발급된다.

### **7.3.2 default_table_encryption**

- 시스템 변수로 기본 암호화 여부를 지정할 수 있다.
- 설정 시 명시하지 않아도 암호화 테이블로 생성된다.

### **7.3.3 응용 프로그램 암호화와 비교**

### **응용 프로그램 암호화**

- 암호화와 복호화를 애플리케이션에서 수행한다.
- MySQL은 해당 컬럼이 암호화되었는지 인지하지 못한다.
- 저장되는 값은 의미 없는 문자열로 취급된다.
- 인덱스는 생성할 수 있으나, 암호화된 데이터 기준으로 생성되어 활용도가 매우 낮다.
- 범위 검색과 정렬이 사실상 불가능하다.
- 실행 계획에서 인덱스가 배제될 가능성이 높다.

### **MySQL TDE**

- 암호화와 복호화를 InnoDB 스토리지 엔진에서 처리한다.
- 디스크에 저장되는 시점에만 암호화된다.
- SQL 실행 시점에는 항상 평문으로 처리된다.
- 인덱스 구조와 동작에 영향을 주지 않는다.
- 범위 검색과 정렬이 정상 동작한다.
- 실행 계획은 암호화 적용 여부와 무관하다.

## **7.3.4 테이블스페이스 이동**

암호화된 테이블은 이동 시 주의가 필요하다.

- 소스 서버와 대상 서버의 마스터 키가 다르다.
- 암호화된 테이블스페이스는 그대로 사용할 수 없다.

이 경우

- FLUSH TABLES FOR EXPORT 사용
- .ibd 파일과 .cfg 파일을 함께 이동해야 한다.
- 임시 마스터 키를 이용해 재암호화된다.

## **7.4 언두 로그와 리두 로그 암호화**

- 테이블 암호화와 별개로 설정한다.
- 서버 실행 중 설정 변경 가능하다.
- 기존 로그는 재암호화되지 않는다.
- 설정 이후 생성되는 로그부터 적용된다.

확인 예시

```sql
SHOW GLOBAL VARIABLES LIKE 'innodb_redo_log_encrypt';
```

## **7.5 바이너리 로그 암호화**

### **7.5.1 바이너리 로그 암호화 구조**

<img width="513" height="394" alt="image" src="https://github.com/user-attachments/assets/c5b2390b-40cb-43ea-9649-ac1e110047d6" />

- 로그 파일 단위로 암호화된다.
- 파일 키로 암호화된다.
- 파일 키는 다시 마스터 키로 암호화된다.

### **7.5.2 바이너리 로그 암호화 키 변경**

```sql
ALTER INSTANCE ROTATE BINLOG MASTER KEY;
```

동작 과정

- 새로운 파일 키 발급
- 새로운 바이너리 로그 파일 생성
- 기존 로그 파일을 순차적으로 재암호화
- 완료 후 이전 키 제거

시간이 오래 걸릴 수 있다.

## **7.5.3 mysqlbinlog 사용 시 주의사항**

- 암호화된 바이너리 로그는 직접 읽을 수 없다.
- 반드시 MySQL 서버를 통해서만 조회 가능하다.
- 로컬 파일을 직접 열어 복호화하는 방법은 없다.

## **7장 전체 정리**

- MySQL 데이터 암호화는 디스크 저장 데이터를 보호한다.
- TDE는 2단계 키 구조를 사용한다.
- 마스터 키 변경은 비용이 작고 안전하다.
- 테이블스페이스 키 변경은 전체 재암호화를 유발한다.
- TDE는 인덱스와 쿼리 성능에 거의 영향을 주지 않는다.
- 로그 암호화는 데이터 보호 범위를 확장한다.
